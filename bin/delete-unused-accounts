#!/usr/bin/env python
"""
Deletes account data permanently for accounts where sync_should_run is False.

Includes:
* All data in the database.
* Account liveness/status data (in Redis).

USE WITH CAUTION.
"""
import click

from inbox.models.session import session_scope
from inbox.models import Account
from inbox.util.delete_accounts import delete_account_data


@click.command()
def delete_unused_accounts():
    question = 'Are you sure you want to delete all accounts with '\
               'sync_should_run set to False? [yes / no] '

    answer = raw_input(question).strip().lower()

    if answer != 'yes':
        print 'Will NOT delete, goodbye.'
        return 0

    overall_time = 0

    print 'Queueing tasks'

    with session_scope() as db_session:
        accounts = db_session.query(Account).filter(Account.sync_should_run == False)

        for account in accounts:
            print 'Account {}'.format(account.id)
            delete_account_data.delay(account.id)

    print 'Tasks have been queued.'

    return 0


if __name__ == '__main__':
    delete_unused_accounts()
